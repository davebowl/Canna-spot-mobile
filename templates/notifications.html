{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>ðŸ”” Notifications</h2>
  {% if notifications %}
    <div class="notif-list">
      {% for n in notifications %}
        <div class="notif-item {% if not n.is_read %}unread{% endif %}" data-id="{{ n.id }}">
          <div class="notif-message">{{ n.message }}</div>
          <div class="notif-time">{{ n.created_at|date }}</div>
          {% if not n.is_read %}
            <button class="btn-mark-read" data-id="{{ n.id }}">Mark as read</button>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="meta">No notifications yet.</p>
  {% endif %}
</div>

<style>
.notif-list{margin-top:16px}
.notif-item{padding:12px;margin:8px 0;border-radius:8px;background:rgba(0,255,153,.05);border:1px solid rgba(0,255,153,.2);display:flex;align-items:center;gap:12px}
.notif-item.unread{background:rgba(0,255,153,.12);border-color:var(--green)}
.notif-message{flex:1;font-size:14px}
.notif-time{font-size:12px;color:var(--dim)}
.btn-mark-read{background:transparent;border:1px solid var(--green);color:var(--green);padding:4px 8px;border-radius:6px;font-size:12px;cursor:pointer}
.btn-mark-read:hover{background:var(--green);color:#000}
</style>

<script>
document.querySelectorAll('.btn-mark-read').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.dataset.id;
    const res = await fetch(`/api/notification/${id}/read`, {method:'POST'});
    const data = await res.json();
    if(data.success) {
      const item = document.querySelector(`.notif-item[data-id="${id}"]`);
      item.classList.remove('unread');
      btn.remove();
      updateBadge();
    }
  });
});

async function updateBadge() {
  const badge = document.getElementById('notifCount');
  if(!badge) return;
  const res = await fetch('/api/notifications/unread');
  const data = await res.json();
  if(data.count > 0) {
    badge.textContent = data.count;
    badge.classList.add('show');
  } else {
    badge.classList.remove('show');
  }
}
</script>
{% endblock %}
