{% extends "base.html" %}
{% block content %}
<div class="wrap" style="max-width:900px;margin:40px auto;padding:20px">
  <h2 style="margin-bottom:30px">My Profile</h2>
  
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% if category == 'success' %}
          <div class="card" style="padding:15px;margin-bottom:20px;background:rgba(0,255,153,0.1);border:1px solid var(--green);">{{ message }}</div>
        {% else %}
          <div class="card" style="padding:15px;margin-bottom:20px;background:rgba(255,0,0,0.1);border:1px solid #ff0000;">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- Status Selector -->
  <div class="card" style="margin-bottom:20px;padding:20px">
    <h3 style="margin:0 0 15px 0">Status</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn {{ 'green' if user.status == 'online' else 'ghost' }}" onclick="setStatus('online')">
        ðŸŸ¢ Online
      </button>
      {% if user.status == 'too_stoned' %}
        <button class="btn" onclick="setStatus('too_stoned')" style="background:#ff00ff;color:#000">ðŸŸ£ Too Stoned</button>
      {% else %}
        <button class="btn ghost" onclick="setStatus('too_stoned')">ðŸŸ£ Too Stoned</button>
      {% endif %}
      <button class="btn {{ 'ghost' if user.status != 'offline' else '' }}" onclick="setStatus('offline')">
        âš« Offline
      </button>
    </div>
    <p style="margin:10px 0 0 0;color:#888;font-size:.9rem">
      Current status: <strong id="currentStatus">{{ user.status|replace('_', ' ')|title }}</strong>
    </p>
  </div>

  <form method="post" class="card" style="padding:20px">
    <h3 style="margin:0 0 15px 0">Profile Settings</h3>
    <label style="display:block;margin-bottom:20px">
      <strong>Username</strong>
      <input name="uname" value="{{ user.uname }}" style="width:100%;margin-top:8px">
    </label>
    <label style="display:block;margin-bottom:20px">
      <strong>Display Name</strong>
      <input name="dname" value="{{ user.dname }}" style="width:100%;margin-top:8px">
    </label>
    
    <div class="code-widget">
      <div class="bar" style="margin-bottom:10px">
        <button type="button" onclick="insertCode('<h3>Welcome to my garden</h3>')">Heading</button>
        <button type="button" onclick="insertCode('<p>My strains: â€¦</p>')">Paragraph</button>
        <button type="button" onclick="insertCode('<img src=&quot;/static/leaf.png&quot; width=&quot;120&quot;>')">Image</button>
        <button type="button" onclick="insertCode('<div class=&quot;badge&quot;>GrowOhio420</div>')">Badge</button>
      </div>
      <textarea id="codebox" name="profile_html" rows="8" style="width:100%">{{ user.profile_html or '<p>Tell folks about your growâ€¦</p>' }}</textarea>
    </div>
    
    <button class="btn green" style="margin-top:15px">Save Profile</button>
  </form>

  <!-- Password Change Section -->
  <form method="post" action="{{ url_for('change_password') }}" class="card" style="padding:20px;margin-top:20px">
    <h3 style="margin:0 0 15px 0">ðŸ”’ Change Password</h3>
    
    <label style="display:block;margin-bottom:15px">
      <strong>Current Password</strong>
      <input type="password" name="current_password" required style="width:100%;margin-top:8px">
    </label>
    
    <label style="display:block;margin-bottom:15px">
      <strong>New Password</strong>
      <input type="password" name="new_password" required minlength="6" style="width:100%;margin-top:8px">
    </label>
    
    <label style="display:block;margin-bottom:15px">
      <strong>Confirm New Password</strong>
      <input type="password" name="confirm_password" required minlength="6" style="width:100%;margin-top:8px">
    </label>
    
    <button class="btn green" style="margin-top:10px">Update Password</button>
  </form>

  {% if user.profile_html %}
  <div class="card" style="padding:20px">
    <h3 style="margin:0 0 15px 0">Preview</h3>
    <div class="preview">{{ user.profile_html | safe }}</div>
  </div>
  {% endif %}
</div>

<script>
function insertCode(s) {
  const t = document.getElementById('codebox');
  t.setRangeText(s, t.selectionStart, t.selectionEnd, 'end');
  t.focus();
}

async function setStatus(status) {
  const res = await fetch('/api/status/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: status })
  });
  
  if (res.ok) {
    const data = await res.json();
    document.getElementById('currentStatus').textContent = data.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    // Update button styles
    document.querySelectorAll('.btn').forEach(btn => {
      btn.classList.remove('green');
      btn.classList.add('ghost');
      btn.style.background = '';
      btn.style.color = '';
    });
    
    event.target.classList.remove('ghost');
    if (status === 'online') {
      event.target.classList.add('green');
    } else if (status === 'too_stoned') {
      event.target.style.background = '#ff00ff';
      event.target.style.color = '#000';
    }
  } else {
    alert('Failed to update status');
  }
}
</script>
{% endblock %}
