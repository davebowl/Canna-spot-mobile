{% extends "base.html" %}
{% block content %}
<div style="display:grid;grid-template-columns:280px 1fr;gap:16px;height:calc(100vh - 120px)">
  <!-- Friends sidebar -->
  <div class="card" style="overflow-y:auto">
    <h3 style="margin-bottom:12px">Messages</h3>
    {% for friend in friends %}
    <a href="{{ url_for('messages', friend_id=friend.id) }}" 
       class="friend-item {% if active_friend and active_friend.id == friend.id %}active{% endif %}"
       style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;margin:4px 0;border:1px solid transparent;text-decoration:none;color:var(--text)">
      <img src="{{ friend.avatar or '/static/leaf.png' }}" style="width:40px;height:40px;border-radius:50%;border:1px solid var(--green)">
      <div style="flex:1">
        <div style="font-weight:600">{{ friend.username }}</div>
        {% if unread_counts.get(friend.id, 0) > 0 %}
        <span style="background:#ff3333;color:#fff;font-size:11px;padding:2px 6px;border-radius:999px">{{ unread_counts[friend.id] }} new</span>
        {% endif %}
      </div>
    </a>
    {% else %}
    <p class="tiny" style="opacity:.7">No friends yet. <a href="{{ url_for('friends') }}">Add friends</a> to start messaging.</p>
    {% endfor %}
  </div>
  
  <!-- Chat area -->
  <div class="card" style="display:flex;flex-direction:column">
    {% if active_friend %}
    <div style="padding:12px;border-bottom:1px solid rgba(0,255,153,.3);display:flex;align-items:center;gap:12px">
      <img src="{{ active_friend.avatar or '/static/leaf.png' }}" style="width:48px;height:48px;border-radius:50%;border:1px solid var(--green)">
      <div style="flex:1">
        <strong>{{ active_friend.username }}</strong>
        <div class="tiny" style="opacity:.7">{{ active_friend.email }}</div>
      </div>
      <button id="videoCallBtn" class="btn" style="display:flex;align-items:center;gap:6px">
        ğŸ“¹ Video Call
      </button>
    </div>
    
    <!-- Video chat area (hidden by default) -->
    <div id="videoChat" class="hidden" style="padding:16px;background:rgba(0,0,0,.8);border-bottom:1px solid rgba(0,255,153,.3)">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div style="position:relative">
          <video id="remoteVideo" autoplay playsinline style="width:100%;aspect-ratio:16/9;background:#000;border-radius:8px;border:1px solid var(--green)"></video>
          <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,.7);padding:4px 8px;border-radius:4px;font-size:.85rem">{{ active_friend.username }}</div>
        </div>
        <div style="position:relative">
          <video id="localVideo" autoplay muted playsinline style="width:100%;aspect-ratio:16/9;background:#000;border-radius:8px;border:1px solid var(--green)"></video>
          <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,.7);padding:4px 8px;border-radius:4px;font-size:.85rem">You</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="toggleVideo" class="btn ghost">ğŸ“¹ Camera</button>
        <button id="toggleAudio" class="btn ghost">ğŸ¤ Mic</button>
        <button id="endCall" class="btn" style="background:#ff3333">End Call</button>
      </div>
    </div>
    
    <div id="chatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px">
      {% for msg in conversation %}
      <div class="message {% if msg.sender_id == user.id %}sent{% else %}received{% endif %}"
           style="max-width:70%;padding:10px 14px;border-radius:12px;{% if msg.sender_id == user.id %}align-self:flex-end;background:var(--green);color:#000;{% else %}align-self:flex-start;background:rgba(0,255,153,.12);border:1px solid rgba(0,255,153,.3);{% endif %}">
        <div>{{ msg.content }}</div>
        <div class="tiny" style="margin-top:4px;opacity:.7;font-size:.75rem">{{ msg.created_at|date("%I:%M %p") }}</div>
      </div>
      {% endfor %}
    </div>
    
    <form id="messageForm" style="padding:12px;border-top:1px solid rgba(0,255,153,.3);display:flex;gap:8px;position:relative">
      <button type="button" id="emojiBtn" class="btn ghost" style="padding:6px 12px">ğŸ˜Š</button>
      <div id="emojiPicker" class="hidden" style="position:absolute;bottom:60px;left:12px;background:var(--card);border:1px solid var(--green);border-radius:8px;padding:12px;max-width:300px;box-shadow:0 4px 12px rgba(0,0,0,.4);z-index:100">
        <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px">
          <button type="button" class="emoji-btn" data-emoji="ğŸ˜Š">ğŸ˜Š</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
          <button type="button" class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸŒ¿">ğŸŒ¿</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ’š">ğŸ’š</button>
          <button type="button" class="emoji-btn" data-emoji="âœ¨">âœ¨</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ’¯">ğŸ’¯</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ™">ğŸ™</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ˜">ğŸ˜</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ¤”">ğŸ¤”</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ˜">ğŸ˜</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ¥³">ğŸ¥³</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸŒ±">ğŸŒ±</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸƒ">ğŸƒ</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ’ª">ğŸ’ª</button>
          <button type="button" class="emoji-btn" data-emoji="â­">â­</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ¯">ğŸ¯</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸš€">ğŸš€</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸ’¡">ğŸ’¡</button>
          <button type="button" class="emoji-btn" data-emoji="ğŸµ">ğŸµ</button>
        </div>
      </div>
      <input type="text" id="messageInput" placeholder="Type a message..." style="flex:1" required>
      <button type="submit" class="btn">Send</button>
    </form>
    {% else %}
    <div style="flex:1;display:flex;align-items:center;justify-content:center;opacity:.5">
      <div style="text-align:center">
        <div style="font-size:48px;margin-bottom:12px">ğŸ’¬</div>
        <p>Select a friend to start chatting</p>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
.friend-item:hover { background: var(--soft); border-color: var(--green); }
.friend-item.active { background: var(--green); color: #000; }
.emoji-btn { background:transparent; border:none; font-size:24px; cursor:pointer; padding:4px; border-radius:4px; transition:all .2s; }
.emoji-btn:hover { background:var(--soft); transform:scale(1.2); }
</style>

{% if active_friend %}
<script>
const form = document.getElementById('messageForm');
const input = document.getElementById('messageInput');
const chatBox = document.getElementById('chatMessages');

form?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const content = input.value.trim();
  if(!content) return;
  
  try {
    const res = await fetch('/api/message/send/{{ active_friend.id }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });
    
    if(res.ok) {
      const data = await res.json();
      // Add message to UI
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message sent';
      msgDiv.style.cssText = 'max-width:70%;padding:10px 14px;border-radius:12px;align-self:flex-end;background:var(--green);color:#000;';
      msgDiv.innerHTML = `<div>${content}</div><div class="tiny" style="margin-top:4px;opacity:.7;font-size:.75rem">Just now</div>`;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      input.value = '';
    }
  } catch(e) { console.error(e); }
});

// Scroll to bottom on load
chatBox.scrollTop = chatBox.scrollHeight;

// Emoji picker
const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('emojiPicker');
const emojiButtons = document.querySelectorAll('.emoji-btn');

emojiBtn?.addEventListener('click', (e) => {
  e.stopPropagation();
  emojiPicker.classList.toggle('hidden');
});

document.addEventListener('click', (e) => {
  if(!emojiBtn?.contains(e.target) && !emojiPicker?.contains(e.target)) {
    emojiPicker?.classList.add('hidden');
  }
});

emojiButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const emoji = btn.dataset.emoji;
    input.value += emoji;
    input.focus();
    emojiPicker.classList.add('hidden');
  });
});

// Video Chat
let localStream = null;
let peerConnection = null;
const videoCallBtn = document.getElementById('videoCallBtn');
const videoChatDiv = document.getElementById('videoChat');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const toggleVideoBtn = document.getElementById('toggleVideo');
const toggleAudioBtn = document.getElementById('toggleAudio');
const endCallBtn = document.getElementById('endCall');

videoCallBtn?.addEventListener('click', async () => {
  try {
    // Get local media
    localStream = await navigator.mediaDevices.getUserMedia({ 
      video: true, 
      audio: true 
    });
    localVideo.srcObject = localStream;
    
    // Show video chat UI
    videoChatDiv.classList.remove('hidden');
    videoCallBtn.disabled = true;
    
    // Note: Full P2P connection requires WebRTC signaling server
    // For now, this shows local video. Add Socket.IO for full implementation
    alert('Video chat started! Note: Full peer-to-peer connection requires a signaling server (Socket.IO). Currently showing local video preview.');
    
  } catch(e) {
    console.error('Camera access error:', e);
    alert('Could not access camera/microphone. Please check permissions.');
  }
});

toggleVideoBtn?.addEventListener('click', () => {
  if(localStream) {
    const videoTrack = localStream.getVideoTracks()[0];
    videoTrack.enabled = !videoTrack.enabled;
    toggleVideoBtn.style.opacity = videoTrack.enabled ? '1' : '0.5';
    toggleVideoBtn.textContent = videoTrack.enabled ? 'ğŸ“¹ Camera' : 'ğŸ“¹ Camera (off)';
  }
});

toggleAudioBtn?.addEventListener('click', () => {
  if(localStream) {
    const audioTrack = localStream.getAudioTracks()[0];
    audioTrack.enabled = !audioTrack.enabled;
    toggleAudioBtn.style.opacity = audioTrack.enabled ? '1' : '0.5';
    toggleAudioBtn.textContent = audioTrack.enabled ? 'ğŸ¤ Mic' : 'ğŸ¤ Mic (muted)';
  }
});

endCallBtn?.addEventListener('click', () => {
  if(localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }
  if(peerConnection) {
    peerConnection.close();
    peerConnection = null;
  }
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  videoChatDiv.classList.add('hidden');
  videoCallBtn.disabled = false;
});
</script>
{% endif %}
{% endblock %}
